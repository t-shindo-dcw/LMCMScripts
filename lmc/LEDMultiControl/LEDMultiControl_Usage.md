

# LEDMultiControl　簡易マニュアル

23.9.13  DCraftWork

-------------------------------------------------
## LEDMultiControlの構成
-------------------------------------------------

###  LEDMultiControl

Linux用コンソールアプリ。シェルで起動可能。
RaspberryPiからSPIを通したLMCM制御（ローカルモード）、およびマルチ画面のマスターの機能をつ。

###　LEDMultiControlWin

Windows用コンソールアプリ。シェルやウインドウから起動可能。
Windowsの画面キャプチャ機能を持つ。USB接続されたLMCMの制御も可能である。
MP4などの動画再生機能は省略されている。
それ以外はすべてLEDMultiControlと同じ。

---------------------------------------------------------
## 　ローカルモード　基本動作
---------------------------------------------------------

　LMCとSPI接続されたRaspberryPi上で使用する。

### 動作方法

- BMPファイル使用　一枚絵モード。

>	sudo ./LEDMultiControl -pLMC_FC_64x32.dat BMPFile.bmp

- BMPファイル使用　横スクロールモード　画像全体に対して右から左

>	sudo ./LEDMultiControl -sc -pLMC_FC_64x32.dat BMPFile.bmp

- BMPファイル使用　縦スクロールモード　画像全体に対して下から上

>	sudo ./LEDMultiControl -sv -pLMC_FC_64x32.dat BMPFile.bmp

- MP4ファイル使用　動画再生モード

>	sudo ./LEDMultiControl -mo -pLMC_FC_64x32.dat movie.mp4 

　テンプレートファイルは別ディレクトリにあるときはディレクトリ付きのフルパスを指定する必要がある。

- ヘルプ表示

>	LEDMultiControl -h

### テンプレート

　LMC_FC_64x32.datなどのテンプレートファイルは、表示する画像と複数のLEDマトリックスとの対応関係を示すためのXMLファイルである。内部的には、64x32ドットなどのタイルを複数敷き詰める形で表現されている。

　サンプルテンプレートは以下の通り。

- LMCM_P6_64x32.dat	P6（スキャンライン8） 64x32ドット

- LMCM_P6_64x64.dat	P6（スキャンライン8） 64x64ドット

- LMCM_P6_64x96.dat	P6（スキャンライン8） 64x96ドット

- LMCM_P6_128x192.dat	P6（スキャンライン8） 128x192ドット

- LMCM_P6_192x128.dat	P6（スキャンライン8） 192x128ドット

- LMCM_P10_64x32.dat	P10（スキャンライン4） 64x32ドット

- LMCM_P10_64x48.dat	P10（スキャンライン4） 64x48ドット

- LMCM_P10_128x32.dat	P10（スキャンライン4）  128x32ドット

- LMCM_P10_192x128.dat	P10（スキャンライン4）  192x128ドット

- LMCM_P10KL_64x32.dat	P10（スキャンライン4）Kinglight製LED用  64x32ドット

- FC_64x32.dat	LMC04（旧シリーズ）用 P6（スキャンライン8）64x32ドット

- FC_64x16.dat	LMC04（旧シリーズ）用 P10（スキャンライン4）64x16ドット

---------------------------------------------------------
## マルチコントロール動作  Raspberry Pi(Linux)
---------------------------------------------------------

１つ以上のLMCスレーブノードを、１つのマスターRaspberyPi（あるいはWindowsから）から集中制御する。LMCに接続されたRPiを、それぞれスレーブのLMCノードとする。マスターになるRPiは１つだけで、１つのマスターからすべてのスレーブへの通信を自動的に行う。１つのスレーブとマスターは同一RaspberryPiでも実行可能だが、高解像度のLMCMでは非推奨とする。

- スレーブ　LMCが接続された各RPi上であらかじめ（主にデーモンとして）起動して待機させる。LMCの接続されたRaspberryPiのノードに対して１つづつ必要になる。

>	LEDMultiControl -s -pLMC_FC_64x32.dat 

- マスター　通常動画再生　mp4などの動画をマルチコントールで再生

>	LEDMultiControl -m -tLMC_MC2_256x192.ltb -mo BMPFile.mp4 -at24

　LMC_MC2_256x192.ltbは、複数のスレーブの画面上の配置、およびIPアドレスの情報を格納したテンプレートファイルで、内容はXMLファイルである。

---------------------------------------------------------
## Windowsキャプチャ動作（LANでRaspberryPi+LMCMに接続）
---------------------------------------------------------

　Windowsの表示画面を、RPi上のスレーブに対してリアルタイムで画像を送る。スレーブはRaspberryPi上であらかじめ動作させておく必要がある。

- 画面をキャプチャして単一スレーブに送る。

>	LEDMultiControlWin -m -ca -pLMC_FC_64x32.dat -mI192.168.2.205 -mX100 -mY100 -mX128 -mY64 -at24

- 画面をキャプチャしてマルチコントロールで表示する。表示するスレーブの情報はテンプレートで指定する。

>	LEDMultiControlWin -m -ca -tLMC_MC2_256x192.ltb -mX100 -mY100 -mX128 -mY64 -at24

---------------------------------------------------------
## キャプチャ動作（USBでLMCMに直接接続）
---------------------------------------------------------

　Windowsの表示画面を、USB接続されたLMCMに対して直接リアルタイムで画像を送る。

- 画面をキャプチャして単一スレーブに送る。

>	LEDMultiControlWin -ca -pLMC_FC_64x32.dat  -mX100 -mY100 -mX128 -mY64 

---------------------------------------------------------
## 　ローカルモード、マルチコントロールモード共通オプション
---------------------------------------------------------

　以下のオプションは、ローカルモード、マルチコントロールモード共通で使用可能。マスターモードであれば、スレーブに対して自動分配転送される。

### 動画オプション
　
- 動画モード　-mo

	ファイル名でMP4などの動画を指定。

- 横スクロールモード　-sc

	ファイル名でスクロールするBMPファイルを指定。

- 縦スクロールモード　-sv

	ファイル名でスクロールするBMPファイルを指定。

- キャプチャモード -ca

	ファイル名は不要。Windows限定。

　いずれも指定しない場合はBMPファイルを静止画として表示する。更にBMPファイルがない場合は画面を消去する。

### 基本オプション。

- 輝度 -ab[0-255]

	全体輝度を指定する。省略時は-ab255。

- 輝度制限　-at[0-255]

	自動輝度（電流）制限機能。省略時は-at128。LEDの点灯率が輝度制限を超えた場合は、全体輝度を自動的に調節する。255を指定すると輝度制限制御なし。
	
	例えば、-at64を指定すると、LEDの最大電流の4分の1(64/255)以上の電流が流れると予測できる場合に電流が4分の1以下になるように自動的に輝度を調整する。

- 動画画面回転 -Sr[0,90,180,270]

	表示する動画を時計回りに回転する。LMCMの画面に合わせて画像サイズは自動補正される。スクロールの回転には対応していない。

- 表示オフセット -sX[num],-sY[num]

	表示する静止画などの画像の表示開始位置をずらす。原点左上で右下がプラス方向。マイナス値の指定可能。

- ループカウント　-i[0-32767]

	省略時は-i1。-i0で無限ループ。

- スクロールオフセット座標　-so[0-255]

	左上を原点にして、スクロール画像の表示位置オフセットを指定、横スクロールならば縦ドット数、縦スクロールならば横ドット数を指定。

- スクロール速度　-sp[0.1-16.0]
		
	-sp0.8などの小数点以下の指定が可能で、画像のスムージングも行われる。省略時は-sp1.0。

- スクロール反転　-sr

	横スクロールならば、左から右へのスクロールになる。縦スクロールならば、下から上へのスクロールになる。

- 初期化省略コマンド -w

	初期化時間を短縮できる。通常は動画再生前に１秒前後のLMC初期化を行う。モード切替時には初期化が必要になる。

- プロセス番号記録コマンド -P[filename]

	現在のLEDMultiControlのプロセス番号を記録する。Linux版のみ。

---------------------------------------------------------
## ローカルモード、スレーブモード共通オプション
---------------------------------------------------------

- パターンテンプレート -p[patternfile]

	ローカルで使用するパターンを指定する。

- SPI信号の動作速度(MHz) -ss[float]

	SPIの動作周波数をMHｚで指定する。省略時は最大値の-ss43。

- SPIをioctlモードで動作させる。 -si

	RaspberryPiの起動直後はbcm2835ライブラリが動作していないことがあるため、対症療法として起動直後は標準のioctlを使用するためにこのオプションを指定する。
	LMCMにはSPIの高速通信が必要であるためbcm2835ライブラリがデフォルトとなる。

---------------------------------------------------------
## マルチコントロールオプション
---------------------------------------------------------

### マスター関連オプション

- マスターモード　-m

	マスターモードを示す。１つ以上のスレーブに対して、画像をその都度ネットワークを通じてTCPストリーム転送する。

- スレーブモード　-s

	スレーブノードを示す。マスターからのTCPストリーム通信を受けて、SPI接続されたLMCを制御する。

- ローカルモード

	-m,-sのどちらも指定しない場合は、ローカルにSPI接続されたLMCを直接制御する。

- マスターモードテンプレート　-t[templatefile]

	スレーブの情報を持つテンプレートファイルを指定する。スレーブのIPアドレス情報を事前に記録しておく。

### キャプチャ関連オプション

- 動画キャプチャモード　-ca

	Windows専用コマンド。現在Windows上の動画像をキャプチャするファイルとなる。
  -mとの併用による録画監視も可能であるが、性能の低下の可能性がある。

	Windowsの画面上で、キャプチャする範囲をWindowsのドット単位で指定する。キャプチャ範囲のドットは、FC_Blockで指定された画面サイズに対して、自動的にリサイズされる。

- キャプチャ座標X  -cX[0-65535]

	　画面左上を原点としたときの座標値。Windowsの仮想座標で指定。

- キャプチャ座標Y  -cY[0-65535]

	画面左上を原点としたときの座標値。Windowsの仮想座標で指定。

- キャプチャサイズ横  -cW[0-65535]

	画面左上を原点としたときの座標値。Windowsの仮想座標で指定。

- キャプチャサイズ縦  -cH[0-65535]

	画面左上を原点としたときの座標値。Windowsの仮想座標で指定。

- キャプチャ座標X  -cXR[0-100]

	画面全体を100としたときの相対値指定。

- キャプチャ座標Y  -cYR[0-100]

	画面全体を100としたときの相対値指定。

- キャプチャサイズ横  -cWR[0-100]

	画面全体を100としたときの相対値指定。

- キャプチャサイズ縦  -cHR[0-100]

	画面全体を100としたときの相対値指定。

- 単一スレーブIPアドレス　-mI[0.0.0.0-255.255.255.255]

	単一スレーブを制御するために、-LMC_MC2_256x192等の代わりに直接IPを指定することができる。ポート番号の代わりに、ドメインネームを使用することもできる。
　
- 単一スレーブTCPポート番号　-mT[0-65535]

	ポート番号の変更が必要な場合に設定する。省略時は-mT49200

- 単一スレーブUDPポート番号　-mU[0-65535]

	ポート番号の変更が必要な場合に設定する。省略時は-mT49201

- 単一スレーブ画像サイズ指定　-mX[num],-mY[num]

	IPアドレスで指定した単一スレーブに対して、テンプレートを指定せずにサイズを固定して画像を送ることが可能になる。

### マルチコントロールテンプレート

　LMC_MC2_256x192.ltbなどのブロックテンプレートファイルは、マスターで再生する全体画像と、スレーブブロックとの関連を示すためのファイルである。
スレーブの座標、サイズ、90度単位の回転と、スレーブのIPアドレス（あるいはドメイン名）などから構成される。

　サンプルテンプレートは以下の通り。

- LMC_MC2_256x192.ltb　縦長128x192ドットのLMCMを横に2ノード設置。256x192ドット。

以下が、XMLテンプレートの内容の一部となる。これが１つのSlaveの情報となる。

```
<BLOCK>
	<ID>1</ID>
	<BlockType>0</BlockType>
	<BlockDirection>90</BlockDirection>
	<BlockLocation_X>0</BlockLocation_X>
	<BlockLocation_Y>0</BlockLocation_Y>
	<BlockLocation_W>64</BlockLocation_W>
	<BlockLocation_H>32</BlockLocation_H>
	<BlockDotPitch>0</BlockDotPitch>
	<BlockColorType>0</BlockColorType>
	<BlockIP>169.254.191.154</BlockIP>
</BLOCK>
```

- BlockLocation_X,Yで全体画面の中でのSlaveの開始点を指定。
- BlockLocation_W,Hで全体画面内部でのSlaveブロックのドットサイズを指定。回転前の値。
- BlockDirectionで、画面からSlaveへの画面への回転を反時計回りで90度単位で指定。0.90,180,270度。

    たとえば、W、Hが64、32ドットでDirectionが90度ならば、それぞれのSlaveは画面上では横32、縦64ドットのサイズになる。

- BlockIPで、SlaveのIPアドレスを指定する。ドメインネームも指定できる。

---------------------------------------------------------
## 　スレーブモードオプション
---------------------------------------------------------

- スレーブモード指定 -s

	LEDMultiControlはスレーブ状態として待機状態となる。マスターからのTCP受信で自動的に表示を行う。

- スレーブモードTCPポート番号　-ST[1-65535]

	必要な場合に限り、スレーブに用いるTCP通信ポート番号を任意に変更できる。デフォルトは-ST49200。LEDMultiControlは、TCPとUDPの２つのポートを使用する。

- スレーブモードUDPポート番号　-SU[1-65535]

	必要な場合に限り、スレーブに用いるUDP通信ポート番号を任意に変更できる。デフォルトは-SU49201

- パターンテンプレート -p[patternfile]

	LMCMの表示で使用するパターンを指定する。

- SPI信号の動作速度(MHz) -ss[float]

	SPIの動作周波数をMHｚで指定する。デフォルトでは最大値の-ss43。

- SPIをioctlモードで動作させる。 -si

	RaspberryPiの起動直後はbcm2835ライブラリが動作していないことがあるため、対症療法として起動直後は標準のioctlを使用するためにこのオプションを指定する。
	LMCMにはSPIの高速通信が必要であるためbcm2835ライブラリがデフォルトとなる。


